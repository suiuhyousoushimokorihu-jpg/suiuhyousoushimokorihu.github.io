<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord ãƒã‚¤ãƒ³ãƒˆçµ±è¨ˆ</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1 { color: #7289da; text-align: center; margin-bottom: 20px; }
        h2 { border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-top: 0; }
        .tabs { display: flex; margin-bottom: 0; border-bottom: 2px solid #ccc; }
        .tab-button { 
            padding: 10px 15px; cursor: pointer; border: 1px solid #ccc; border-bottom: none; 
            background: #eee; font-weight: bold; margin-bottom: -2px; 
            transition: background 0.2s, color 0.2s; border-top-left-radius: 5px; border-top-right-radius: 5px;
            z-index: 1; 
        }
        .tab-button.active { 
            background: #fff; color: #7289da; border-color: #ccc; border-bottom-color: #fff; 
        }
        .content-section { 
            padding: 15px; background: #fff; border: 1px solid #ccc; 
            border-top: none; 
            border-bottom-left-radius: 5px; border-bottom-right-radius: 5px;
            min-height: 300px; 
        }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
        th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #ddd; white-space: nowrap; }
        th { background-color: #7289da; color: white; font-weight: 600; cursor: pointer; }
        tr:hover { background-color: #f1f1f1; }
        .rank-number { font-size: 1.2em; font-weight: bold; color: #36393f; }
        .sort-indicator { margin-left: 5px; font-size: 0.8em; }
        .error { color: red; text-align: center; font-weight: bold; }
        .loading { text-align: center; color: #555; }
        #guildIdInput, button { padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
        button { background-color: #5865f2; color: white; cursor: pointer; border: none; }
        button:hover { background-color: #4752c4; }
        .logs-table th:nth-child(1), .logs-table td:nth-child(1) { width: 10%; }
        .logs-table th:nth-child(2), .logs-table td:nth-child(2) { width: 15%; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Discord ãƒã‚¤ãƒ³ãƒˆçµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        <p id="current-time" style="text-align: right; margin-top: -10px; font-size: 0.9em; color: #555;">ç¾åœ¨æ™‚åˆ»ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        
        <p>â€» ãƒœãƒƒãƒˆãŒèµ·å‹•ã—ã€Web APIã‚µãƒ¼ãƒãƒ¼ãŒå‹•ä½œã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>

        <label for="guildIdInput">ã‚µãƒ¼ãƒãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:</label>
        <input type="text" id="guildIdInput" value="1249724116857257984" style="width: 250px; margin-right: 10px;">
        <button onclick="loadData()">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—</button>

        <hr>

        <div id="tabs" class="tabs">
            <div class="tab-button active" data-target="ranking">ğŸ† ç·åˆãƒã‚¤ãƒ³ãƒˆ</div>
            <div class="tab-button" data-target="daily_logs">ğŸ“Š æ—¥åˆ¥ç²å¾—ãƒ­ã‚° (å…¨æœŸé–“)</div>
            <div class="tab-button" data-target="yesterday_stats">ğŸ—“ï¸ æ˜¨æ—¥ã®ç²å¾—çµ±è¨ˆ</div>
        </div>

        <div class="content-section">
            <div id="ranking" class="tab-content">
                <h2>ç·åˆãƒã‚¤ãƒ³ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
                <div id="ranking-content"></div>
            </div>
            <div id="daily_logs" class="tab-content" style="display: none;">
                <h2>æ—¥åˆ¥ç²å¾—ãƒ­ã‚° (å…¨æœŸé–“)</h2>
                <div id="daily_logs-content"></div>
            </div>
            <div id="yesterday_stats" class="tab-content" style="display: none;">
                <h2 id="yesterday-title">æ˜¨æ—¥ã®ç²å¾—çµ±è¨ˆ</h2>
                <div id="yesterday_stats-content"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api';
        let currentGuildId = '1249724116857257984';
        let activeTab = 'ranking';
        let currentRankingData = []; 
        let currentLogsData = [];
        
        // æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãŸã‚ã«ç¾åœ¨ã®æ—¥ä»˜ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let currentDay = ''; 

        // ğŸ”½ ä¿®æ­£ã•ã‚ŒãŸ getYesterdayDateString é–¢æ•° ğŸ”½
        function getYesterdayDateString() {
            const today = new Date();
            const yesterday = new Date(today);
            
            // ç¢ºå®Ÿã«1æ—¥æˆ»ã™
            yesterday.setDate(today.getDate() - 1); 
            
            // æ—¥æœ¬æ™‚é–“ (JST) ã§ YYYY-MM-DD å½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹
            // timeZone: 'Asia/Tokyo' ã‚’æ˜ç¤ºã™ã‚‹ã“ã¨ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è¨­å®šã«ä¾å­˜ã›ãšJSTã§è¨ˆç®—ã•ã›ã‚‹
            const options = { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Asia/Tokyo' };
            
            // toLocaleDateString ã®å‡ºåŠ›ä¾‹: '2025/11/17' (ja-JPãƒ­ã‚±ãƒ¼ãƒ«ã‚’ä½¿ç”¨)
            const formattedDate = yesterday.toLocaleDateString('ja-JP', options);
            
            // '2025/11/17' ã‚’ '2025-11-17' ã«å¤‰æ›ã—ã¦è¿”ã™
            return formattedDate.replace(/\//g, '-'); 
        }
        // ğŸ”¼ ä¿®æ­£ã•ã‚ŒãŸ getYesterdayDateString é–¢æ•° ğŸ”¼


        async function loadData() {
            const guildId = document.getElementById('guildIdInput').value.trim();
            if (!guildId) {
                alert('ã‚µãƒ¼ãƒãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            currentGuildId = guildId;
            
            document.getElementById('ranking-content').innerHTML = '<p class="loading">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
            document.getElementById('daily_logs-content').innerHTML = '<p class="loading">ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
            document.getElementById('yesterday_stats-content').innerHTML = `<p class="loading">æ˜¨æ—¥ã®çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ (${getYesterdayDateString()}) ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>`;

            await fetchRanking();
            await fetchLogs();

            renderRankingTable(currentRankingData, 'total_points', 'desc');
            renderDailyLogsTable(currentLogsData, 'log_date', 'desc');
            renderYesterdayStatsTable(currentLogsData); 
        }

        async function fetchRanking() { 
            try {
                const response = await fetch(`${API_BASE_URL}/members/${currentGuildId}`);
                const data = await response.json();
                
                if (response.status !== 200 || data.error) {
                    document.getElementById('ranking-content').innerHTML = `<p class="error">ã‚¨ãƒ©ãƒ¼: ${data.error || 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼IDã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'}</p>`;
                    currentRankingData = [];
                    return;
                }

                currentRankingData = data;
            } catch (error) {
                document.getElementById('ranking-content').innerHTML = '<p class="error">APIæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒœãƒƒãƒˆã®Webã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';
                currentRankingData = [];
            }
        }

        async function fetchLogs() {
            try {
                const response = await fetch(`${API_BASE_URL}/logs/${currentGuildId}`);
                const data = await response.json();
                
                if (response.status !== 200 || data.error) {
                    document.getElementById('daily_logs-content').innerHTML = `<p class="error">ã‚¨ãƒ©ãƒ¼: ${data.error || 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼IDã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'}</p>`;
                    document.getElementById('yesterday_stats-content').innerHTML = `<p class="error">ã‚¨ãƒ©ãƒ¼: ${data.error || 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼IDã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'}</p>`;
                    currentLogsData = [];
                    return;
                }

                currentLogsData = data;
            } catch (error) {
                document.getElementById('daily_logs-content').innerHTML = '<p class="error">APIæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒœãƒƒãƒˆã®Webã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';
                document.getElementById('yesterday_stats-content').innerHTML = '<p class="error">APIæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒœãƒƒãƒˆã®Webã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';
                currentLogsData = [];
            }
        }

        function renderRankingTable(data, sortBy, sortOrder) {
            const container = document.getElementById('ranking-content');
            if (data.length === 0) {
                container.innerHTML = '<p class="loading">è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            data.sort((a, b) => {
                const valA = a[sortBy];
                const valB = b[sortBy];
                let comparison = 0;
                if (valA > valB) comparison = 1;
                else if (valA < valB) comparison = -1;
                return sortOrder === 'desc' ? (comparison * -1) : comparison;
            });

            let html = `
                <table data-sort-by="${sortBy}" data-sort-order="${sortOrder}">
                    <thead>
                        <tr>
                            <th onclick="sortTable('ranking', 'rank')">é †ä½ <span class="sort-indicator">${sortBy === 'rank' ? (sortOrder === 'asc' ? 'â–²' : 'â–¼') : ''}</span></th>
                            <th onclick="sortTable('ranking', 'username')">ãƒ¦ãƒ¼ã‚¶ãƒ¼å <span class="sort-indicator">${sortBy === 'username' ? (sortOrder === 'asc' ? 'â–²' : 'â–¼') : ''}</span></th>
                            <th onclick="sortTable('ranking', 'total_points')">ç·ãƒã‚¤ãƒ³ãƒˆ <span class="sort-indicator">${sortBy === 'total_points' ? (sortOrder === 'asc' ? 'â–²' : 'â–¼') : ''}</span></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach(item => {
                html += `
                    <tr>
                        <td class="rank-number">${item.rank}</td>
                        <td>${item.username}</td>
                        <td>${item.total_points.toLocaleString()} P</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function renderDailyLogsTable(data, sortBy, sortOrder) {
            const container = document.getElementById('daily_logs-content');
            if (data.length === 0) {
                container.innerHTML = '<p class="loading">è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            data.sort((a, b) => {
                const valA = a[sortBy];
                const valB = b[sortBy];
                let comparison = 0;
                if (valA > valB) comparison = 1;
                else if (valA < valB) comparison = -1;
                return sortOrder === 'desc' ? (comparison * -1) : comparison;
            });

            let html = `
                <table class="logs-table" data-sort-by="${sortBy}" data-sort-order="${sortOrder}">
                    <thead>
                        <tr>
                            <th onclick="sortTable('daily_logs', 'log_date')">æ—¥ä»˜ <span class="sort-indicator">${sortBy === 'log_date' ? (sortOrder === 'asc' ? 'â–²' : 'â–¼') : ''}</span></th>
                            <th onclick="sortTable('daily_logs', 'username')">ãƒ¦ãƒ¼ã‚¶ãƒ¼å <span class="sort-indicator">${sortBy === 'username' ? (sortOrder === 'asc' ? 'â–²' : 'â–¼') : ''}</span></th>
                            <th onclick="sortTable('daily_logs', 'total_earned_today')">åˆè¨ˆç²å¾—P <span class="sort-indicator">${sortBy === 'total_earned_today' ? (sortOrder === 'asc' ? 'â–²' : 'â–¼') : ''}</span></th>
                            
                            <th onclick="sortTable('daily_logs', 'count_message')">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•° <span class="sort-indicator">${sortBy === 'count_message' ? (sortOrder === 'asc' ? 'â–²' : 'â–¼') : ''}</span></th>
                            <th>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸P</th>
                            
                            <th onclick="sortTable('daily_logs', 'count_vc_minutes')">VCæ™‚é–“(åˆ†) <span class="sort-indicator">${sortBy === 'count_vc_minutes' ? (sortOrder === 'asc' ? 'â–²' : 'â–¼') : ''}</span></th>
                            <th>VCåˆè¨ˆP</th>

                            <th>ã‚¬ãƒãƒ£P</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach(item => {
                html += `
                    <tr>
                        <td>${item.log_date}</td>
                        <td>${item.username}</td>
                        <td>${item.total_earned_today.toLocaleString()} P</td>
                        
                        <td>${item.count_message.toLocaleString()} é€š</td>
                        <td>${item.sources.message.toLocaleString()} P</td>
                        
                        <td>${item.count_vc_minutes.toLocaleString()} åˆ†</td>
                        <td>${item.sources.vc.toLocaleString()} P</td>
                        
                        <td>${item.sources.gacha.toLocaleString()} P</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function renderYesterdayStatsTable(data) {
            const yesterdayDate = getYesterdayDateString();
            
            document.getElementById('yesterday-title').textContent = `æ˜¨æ—¥ã®ç²å¾—çµ±è¨ˆ (${yesterdayDate})`;

            const yesterdayData = data.filter(item => item.log_date === yesterdayDate);
            const container = document.getElementById('yesterday_stats-content');
            
            if (yesterdayData.length === 0) {
                container.innerHTML = `<p class="loading">æ˜¨æ—¥ (${yesterdayDate}) ã®ç²å¾—ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
                return;
            }

            yesterdayData.sort((a, b) => b.total_earned_today - a.total_earned_today);

            let html = `
                <table class="logs-table">
                    <thead>
                        <tr>
                            <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                            <th>åˆè¨ˆç²å¾—P</th>
                            <th>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°</th>
                            <th>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸P</th>
                            <th>VCæ™‚é–“(åˆ†)</th>
                            <th>VCåˆè¨ˆP</th>
                            <th>ã‚¬ãƒãƒ£P</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            yesterdayData.forEach(item => {
                html += `
                    <tr>
                        <td>${item.username}</td>
                        <td>${item.total_earned_today.toLocaleString()} P</td>
                        <td>${item.count_message.toLocaleString()} é€š</td>
                        <td>${item.sources.message.toLocaleString()} P</td>
                        <td>${item.count_vc_minutes.toLocaleString()} åˆ†</td>
                        <td>${item.sources.vc.toLocaleString()} P</td>
                        <td>${item.sources.gacha.toLocaleString()} P</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }


        function sortTable(tabName, sortBy) {
            let data;
            let renderFunc;

            if (tabName === 'ranking') {
                data = currentRankingData;
                renderFunc = renderRankingTable;
            } else if (tabName === 'daily_logs') {
                data = currentLogsData;
                renderFunc = renderDailyLogsTable;
            } else {
                return;
            }

            const container = document.getElementById(`${tabName}-content`);
            const table = container.querySelector('table');
            
            let sortOrder = table.getAttribute('data-sort-order');
            const currentSortBy = table.getAttribute('data-sort-by');
            
            if (currentSortBy === sortBy) {
                sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                if (sortBy === 'username' || sortBy === 'rank' || sortBy === 'log_date') {
                    sortOrder = 'asc';
                } else {
                    sortOrder = 'desc';
                }
            }
            
            if (tabName === 'daily_logs' && sortBy === 'log_date') {
                sortOrder = sortOrder === 'asc' ? 'asc' : 'desc';
            }

            renderFunc(data, sortBy, sortOrder);
        }

        function switchTab(targetId) {
            if (activeTab === targetId) return;

            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-button[data-target="${targetId}"]`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            document.getElementById(targetId).style.display = 'block';

            activeTab = targetId;
        }
        
        // --- ğŸ”½ è¿½åŠ æ©Ÿèƒ½: æ™‚åˆ»æ›´æ–°ã¨æ—¥ã¾ãŸããƒã‚§ãƒƒã‚¯ ğŸ”½ ---
        
        /**
         * ç¾åœ¨æ™‚åˆ»ã‚’æ›´æ–°ã—ã€æ—¥ãŒå¤‰ã‚ã£ãŸå ´åˆã¯ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹
         */
        function updateTimeAndCheckDayChange() {
            const now = new Date();
            
            // æ™‚åˆ»ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (ä¾‹: 2025/11/18 02:08:00)
            const timeOptions = { 
                year: 'numeric', month: '2-digit', day: '2-digit', 
                hour: '2-digit', minute: '2-digit', second: '2-digit', 
                hour12: false,
                timeZone: 'Asia/Tokyo' // JSTã‚’å¼·åˆ¶
            };
            const formattedTime = now.toLocaleDateString('ja-JP', timeOptions);
            
            // æ—¥ä»˜ã®æ–‡å­—åˆ— (ä¾‹: 2025-11-18)
            const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Asia/Tokyo' };
            const today = now.toLocaleDateString('ja-JP', dateOptions).replace(/\//g, '-');

            // 1. æ™‚åˆ»è¡¨ç¤ºã‚’æ›´æ–°
            document.getElementById('current-time').textContent = `ç¾åœ¨æ™‚åˆ»: ${formattedTime}`;

            // 2. æ—¥ãŒå¤‰ã‚ã£ãŸã‹ã©ã†ã‹ã®ãƒã‚§ãƒƒã‚¯
            if (currentDay === '') {
                // åˆå›è¨­å®š
                currentDay = today;
            } else if (currentDay !== today) {
                // æ—¥ã‚’ã¾ãŸã„ã å ´åˆã€ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                console.log(`æ—¥ã‚’ã¾ãŸãã¾ã—ãŸ (${currentDay} -> ${today})ã€‚ãƒšãƒ¼ã‚¸ã‚’è‡ªå‹•æ›´æ–°ã—ã¾ã™ã€‚`);
                location.reload();
            }
        }

        // --- ğŸ”¼ è¿½åŠ æ©Ÿèƒ½: æ™‚åˆ»æ›´æ–°ã¨æ—¥ã¾ãŸããƒã‚§ãƒƒã‚¯ ğŸ”¼ ---


        document.addEventListener('DOMContentLoaded', () => {
            const tabs = document.getElementById('tabs');
            
            tabs.addEventListener('click', (e) => {
                const targetButton = e.target.closest('.tab-button');
                if (targetButton) {
                    const targetId = targetButton.getAttribute('data-target');
                    switchTab(targetId);
                }
            });
            
            // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«æ™‚åˆ»è¡¨ç¤ºã¨ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’å®Ÿè¡Œ
            updateTimeAndCheckDayChange(); 
            loadData();

            // 60ç§’ï¼ˆ60000ãƒŸãƒªç§’ï¼‰ã”ã¨ã«æ™‚åˆ»ãƒã‚§ãƒƒã‚¯ã‚’ç¹°ã‚Šè¿”ã™
            setInterval(updateTimeAndCheckDayChange, 60000); 
        });
    </script>
</body>
</html>
