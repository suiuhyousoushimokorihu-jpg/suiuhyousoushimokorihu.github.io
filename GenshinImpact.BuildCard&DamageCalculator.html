<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>原神ビルドカード＋ダメージ計算（プロキシ版）</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center py-6">

<header class="mb-6">
  <h1 class="text-2xl font-bold">原神ビルドカード＋ダメージ計算（プロキシ版）</h1>
</header>

<main class="w-full max-w-6xl px-4">
  <div id="root"></div>
</main>

<footer class="mt-auto text-gray-400 text-sm">原神ビルドカードサイト © 2025</footer>

<script type="text/javascript">
const { useState } = React;

function calcDamage({atk, crit_rate, crit_dmg, dmg_bonus}, multiplier=1, enemy_res=0.1) {
  const base = atk * multiplier;
  const nonCrit = base * (1 + dmg_bonus);
  const crit = base * (1 + crit_dmg) * (1 + dmg_bonus);
  return Math.round(nonCrit * (1 - crit_rate) + crit * crit_rate) * (1 - enemy_res);
}

function BuildCard({ card }) {
  const damage = calcDamage(card.stats);
  return (
    React.createElement('div', { className: 'bg-white p-2 rounded shadow text-center' },
      React.createElement('img', { src: card.character.icon, alt: card.character.name, className: 'w-16 h-16 mx-auto' }),
      React.createElement('div', { className: 'mt-1 font-bold' }, card.character.name),
      React.createElement('div', null, `LV: ${card.level}`),
      React.createElement('div', null, `ATK: ${card.stats.atk}`),
      React.createElement('div', { className: 'mt-1 text-red-500 font-semibold' }, `予測ダメージ: ${damage}`)
    )
  );
}

function App() {
  const [cards, setCards] = useState([]);
  const [uid, setUid] = useState('');
  const [status, setStatus] = useState('まだ取得されていません');

  const fetchProfile = async () => {
    if (!uid) return;
    setStatus('取得中...');
    try {
      // 自前プロキシ経由で Enka API 取得
      const res = await fetch(`http://localhost:3000/api/uid/${uid}`);
      const data = await res.json();

      if (!data.avatarInfoList) {
        setStatus('キャラクター情報がありません');
        return;
      }

      console.log(data); // デバッグ用

      const newCards = data.avatarInfoList.map(char => ({
        id: char.avatarId,
        character: {
          name: (char.nameTextMap && char.nameTextMap.ja) || `ID:${char.avatarId}`,
          icon: char.icon ? `https://enka.network/ui/${char.icon}` : ''
        },
        level: char.level || 1,
        stats: {
          atk: char.fightPropMap?.[5] || 0,
          crit_rate: char.fightPropMap?.[20] || 0,
          crit_dmg: char.fightPropMap?.[22] || 0,
          dmg_bonus: 0
        }
      }));

      setCards(newCards.slice(0,16));
      setStatus(`UID ${uid} のプロフィール取得完了`);
    } catch(err) {
      console.error(err);
      setStatus('プロフィール取得に失敗しました');
    }
  };

  return React.createElement('div', null,
    React.createElement('div', { className: 'mb-4' },
      React.createElement('input', { type: 'text', value: uid, onChange: e => setUid(e.target.value), placeholder: 'UIDを入力', className: 'border rounded p-2 mr-2' }),
      React.createElement('button', { onClick: fetchProfile, className: 'px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600' }, 'プロフィール取得'),
      React.createElement('p', { className: 'text-sm text-gray-500 mt-2' }, status)
    ),
    React.createElement('div', { className: 'grid grid-cols-4 gap-3' },
      cards.map(card => React.createElement(BuildCard, { key: card.id, card }))
    )
  );
}

ReactDOM.render(React.createElement(App), document.getElementById('root'));
</script>

</body>
</html>
