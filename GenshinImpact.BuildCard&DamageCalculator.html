<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>原神 キャラ表示</title>
<style>
  body { font-family: sans-serif; background:#f0f0f5; padding:20px; display:flex; flex-direction:column; align-items:center; }
  .uid-entry { margin-top:100px; text-align:center; }
  input { padding:10px; width:200px; font-size:16px; }
  button { padding:10px 20px; font-size:16px; cursor:pointer; margin-left:10px; }
  .char-grid { display:flex; flex-wrap:wrap; gap:10px; margin-top:20px; }
  .char-card { cursor:pointer; width:80px; text-align:center; }
  .char-card img { width: 80px; height: 80px; border-radius:10px; }
  .details { background:#fff; padding:15px; border-radius:10px; margin-top:20px; display:none; width:300px; }
  .buttons { margin-top:20px; }
  .buttons button { padding:10px 20px; margin-right:10px; cursor:pointer; }
  .build-card, .damage-calc { background:#fff; padding:15px; border-radius:10px; margin-top:10px; display:none; width:300px; }
</style>
</head>
<body>

<div id="uidEntry" class="uid-entry">
  <input type="text" id="uidInput" placeholder="UIDを入力">
  <button id="loadBtn">読み込む</button>
</div>

<div id="charGrid" class="char-grid"></div>
<div id="charDetails" class="details"></div>

<div class="buttons">
  <button id="buildBtn">ビルドカード作成</button>
  <button id="damageBtn">ダメージ計算機</button>
</div>

<div id="buildArea" class="build-card"></div>
<div id="damageArea" class="damage-calc"></div>

<script>
let avatars = [];
let selectedChar = null;
let UID = '';

// UID入力後キャラ取得
document.getElementById('loadBtn').onclick = async () => {
  UID = document.getElementById('uidInput').value.trim();
  if(!UID) return alert('UIDを入力してください');
  try {
    const res = await fetch(`https://enka.network/api/uid/${UID}`);
    const data = await res.json();
    avatars = data.avatars || [];
    document.getElementById('uidEntry').style.display='none';
    renderCharGrid();
  } catch(e) {
    console.error("取得失敗", e);
    alert('キャラクター取得に失敗しました');
  }
}

// キャラアイコン表示
function renderCharGrid() {
  const grid = document.getElementById('charGrid');
  grid.innerHTML = '';
  avatars.forEach(a => {
    const div = document.createElement('div');
    div.className = 'char-card';
    const img = document.createElement('img');
    img.src = `https://enka.network/ui/${a.icon.replace('.png','')}.png`;
    img.onerror = ()=>{ img.src='https://via.placeholder.com/80'; };
    div.appendChild(img);
    const name = document.createElement('div');
    name.textContent = a.name;
    div.appendChild(name);
    div.onclick = ()=>showDetails(a);
    grid.appendChild(div);
  });
}

// 詳細表示
function showDetails(a) {
  selectedChar = a;
  const details = document.getElementById('charDetails');
  details.style.display = 'block';
  details.innerHTML = `
    <h3>${a.name}</h3>
    <p>LV: ${a.level}</p>
    <p>ATK: ${a.atk.toFixed(1)}</p>
    <p>会心率: ${(a.crit_rate*100).toFixed(1)}%</p>
    <p>会心ダメ: ${(a.crit_dmg*100).toFixed(1)}%</p>
    <p>予測ダメージ: ${a.predictedDmg}</p>
  `;
}

// ビルドカード作成
document.getElementById('buildBtn').onclick = () => {
  document.getElementById('buildArea').style.display='block';
  document.getElementById('damageArea').style.display='none';
  const area = document.getElementById('buildArea');
  area.innerHTML = avatars.map(a=>`
    <div style="border:1px solid #ccc; padding:10px; margin-bottom:5px;">
      <img src="https://enka.network/ui/${a.icon.replace('.png','')}.png" style="width:50px; vertical-align:middle;">
      ${a.name} LV:${a.level} ATK:${a.atk.toFixed(1)}
    </div>
  `).join('');
};

// ダメージ計算機
document.getElementById('damageBtn').onclick = () => {
  document.getElementById('damageArea').style.display='block';
  document.getElementById('buildArea').style.display='none';
  const area = document.getElementById('damageArea');
  if(!selectedChar){ area.innerHTML='キャラクターを選択してください'; return;}
  area.innerHTML = `
    <h3>${selectedChar.name} ダメージ計算</h3>
    <p>ATK: <input id="atkInput" value="${selectedChar.atk.toFixed(1)}"> </p>
    <p>会心率: <input id="critInput" value="${(selectedChar.crit_rate*100).toFixed(1)}">%</p>
    <p>会心ダメ: <input id="cdInput" value="${(selectedChar.crit_dmg*100).toFixed(1)}">%</p>
    <button id="calcBtn">計算</button>
    <p id="result">予測ダメージ: ${selectedChar.predictedDmg}</p>
  `;
  document.getElementById('calcBtn').onclick = ()=>{
    const atk = parseFloat(document.getElementById('atkInput').value);
    const crit = parseFloat(document.getElementById('critInput').value)/100;
    const cd = parseFloat(document.getElementById('cdInput').value)/100;
    const dmg = (atk*(1+crit*cd)).toFixed(1);
    document.getElementById('result').textContent = `予測ダメージ: ${dmg}`;
  }
};
</script>

</body>
</html>
