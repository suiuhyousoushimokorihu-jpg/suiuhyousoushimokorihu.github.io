<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>原神ビルド＆ダメージ計算</title>
<style>
body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; background: #f6f7fb; }
#uidForm { margin-top: 100px; }
#characters { display: flex; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
.charCard { display: flex; flex-direction: column; align-items: center; margin: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; width: 120px; background: #fff; }
.charCard img { width: 64px; height: 64px; margin-bottom: 5px; }
button { margin: 5px; padding: 5px 10px; cursor: pointer; }
#actionButtons { margin-top: 20px; }
#detailView { margin-top: 20px; width: 90%; max-width: 600px; background: #fff; padding: 10px; border-radius: 8px; display: none; }
input[type="number"] { width: 60px; margin-left: 5px; }
.buildCard { border: 1px solid #aaa; margin: 5px; padding: 5px; border-radius: 5px; background: #eef; }
</style>
</head>
<body>

<div id="uidForm">
  <input type="text" id="uidInput" placeholder="UIDを入力" />
  <button onclick="fetchCharacters()">表示</button>
</div>

<div id="characters"></div>

<div id="actionButtons" style="display:none;">
  <button onclick="showBuildCard()">ビルドカード作成</button>
  <button onclick="showDamageCalculator()">ダメージ計算機</button>
</div>

<div id="detailView"></div>

<script>
let currentCharacters = [];

async function fetchCharacters() {
  const uid = document.getElementById('uidInput').value;
  if(!uid) return alert('UIDを入力してくださいですわよ');
  document.getElementById('characters').innerHTML = '取得中...';

  try {
    const res = await fetch(`https://suiuhyousoushimokorihu-jpg.github.io/proxy/api/uid/${uid}`);
    const data = await res.json();
    currentCharacters = data.avatars;

    const charactersDiv = document.getElementById('characters');
    charactersDiv.innerHTML = '';

    data.avatars.forEach(char => {
      const card = document.createElement('div');
      card.className = 'charCard';
      const iconUrl = char.icon.includes('UI_') ? char.icon : `https://enka.network/ui/${char.icon}.png`;
      card.innerHTML = `
        <img src="${iconUrl}" alt="${char.name}">
        <div>${char.name}</div>
        <button onclick="showDetails(${char.id})">詳細</button>
      `;
      charactersDiv.appendChild(card);
    });

    document.getElementById('actionButtons').style.display = 'block';
  } catch(e) {
    document.getElementById('characters').innerHTML = 'キャラクター情報取得できませんでしたですわよ';
    console.error(e);
  }
}

function showDetails(id) {
  const char = currentCharacters.find(c => c.id === id);
  if(!char) return;

  const detailDiv = document.getElementById('detailView');
  detailDiv.style.display = 'block';
  detailDiv.innerHTML = `
    <h3>${char.name}</h3>
    <p>LV: ${char.level}</p>
    <p>ATK: ${char.atk.toFixed(1)}</p>
    <p>クリ率: ${(char.crit_rate*100).toFixed(1)}%</p>
    <p>クリダメ: ${(char.crit_dmg*100).toFixed(1)}%</p>
    <p>予測ダメージ: ${char.predictedDmg}</p>
  `;
}

// --- ビルドカード ---
function showBuildCard() {
  const detailDiv = document.getElementById('detailView');
  detailDiv.style.display = 'block';
  detailDiv.innerHTML = '<h3>ビルドカード作成</h3>';

  currentCharacters.forEach(char => {
    const cardDiv = document.createElement('div');
    cardDiv.className = 'buildCard';
    cardDiv.innerHTML = `
      <strong>${char.name}</strong><br>
      武器: <input type="text" placeholder="武器名"><br>
      聖遺物: <input type="text" placeholder="聖遺物"><br>
      ATK補正: <input type="number" value="0"> CRIT%: <input type="number" value="0"><br>
      <button onclick="alert('カード生成完了ですわよ！')">生成</button>
    `;
    detailDiv.appendChild(cardDiv);
  });
}

// --- ダメージ計算機 ---
function showDamageCalculator() {
  const detailDiv = document.getElementById('detailView');
  detailDiv.style.display = 'block';
  detailDiv.innerHTML = '<h3>ダメージ計算機</h3>';

  currentCharacters.forEach(char => {
    const calcDiv = document.createElement('div');
    calcDiv.className = 'buildCard';
    calcDiv.innerHTML = `
      <strong>${char.name}</strong><br>
      ATK: <input type="number" id="atk_${char.id}" value="${char.atk.toFixed(1)}"><br>
      CRIT%: <input type="number" id="crit_${char.id}" value="${(char.crit_rate*100).toFixed(1)}"><br>
      CRIT DMG%: <input type="number" id="cdmg_${char.id}" value="${(char.crit_dmg*100).toFixed(1)}"><br>
      <button onclick="calcDamage(${char.id})">計算</button>
      <div id="result_${char.id}"></div>
    `;
    detailDiv.appendChild(calcDiv);
  });
}

function calcDamage(id) {
  const atk = parseFloat(document.getElementById(`atk_${id}`).value);
  const crit = parseFloat(document.getElementById(`crit_${id}`).value)/100;
  const cdmg = parseFloat(document.getElementById(`cdmg_${id}`).value)/100;
  const damage = atk * (1 + crit * cdmg);
  document.getElementById(`result_${id}`).innerText = `予測ダメージ: ${damage.toFixed(1)}`;
}
</script>
</body>
</html>
