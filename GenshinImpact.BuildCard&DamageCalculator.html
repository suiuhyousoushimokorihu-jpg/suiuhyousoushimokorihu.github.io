<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>原神ビルドカード＆ダメージ計算</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  #avatars, #damageCalc { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
  .card { border: 1px solid #ccc; padding: 10px; width: 150px; text-align: center; }
  .hidden { display: none; }
  button { margin-right: 10px; margin-top: 10px; }
  #damageCalc .calcCard { border: 1px solid #ccc; padding: 10px; width: 300px; }
</style>
</head>
<body>
<h1>原神ビルドカード & ダメージ計算</h1>

<input type="text" id="uidInput" placeholder="UIDを入力" />
<button id="fetchBtn">プロフィール取得</button>

<div style="margin-top: 20px;">
  <button id="showBuildBtn">ビルドカード表示</button>
  <button id="showDmgBtn">ダメージ計算器表示</button>
</div>

<div id="avatars"></div>

<div id="damageCalc" class="hidden"></div>

<script>
let avatarsData = [];

document.getElementById('fetchBtn').onclick = async () => {
  const uid = document.getElementById('uidInput').value.trim();
  if(!uid) return alert('UIDを入力してください');
  const res = await fetch(`http://localhost:3000/api/uid/${uid}`);
  const data = await res.json();
  avatarsData = data.avatars;

  // 初回はビルドカード表示
  showBuildCards();
};

function showBuildCards() {
  document.getElementById('damageCalc').classList.add('hidden');
  const container = document.getElementById('avatars');
  container.classList.remove('hidden');
  container.innerHTML = '';
  avatarsData.forEach(char => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <img src="${char.icon}" width="80" />
      <p>${char.name}</p>
      <p>LV: ${char.level}</p>
      <p>ATK: ${char.atk}</p>
      <p>予測ダメージ: ${char.predictedDmg}</p>
    `;
    container.appendChild(card);
  });
}

function showDamageCalculator() {
  document.getElementById('avatars').classList.add('hidden');
  const container = document.getElementById('damageCalc');
  container.classList.remove('hidden');
  container.innerHTML = '';

  avatarsData.forEach(char => {
    const calcCard = document.createElement('div');
    calcCard.className = 'calcCard';
    calcCard.innerHTML = `
      <img src="${char.icon}" width="80" />
      <p>${char.name}</p>
      <p>LV: ${char.level}</p>
      <label>ATK: <input type="number" value="${char.atk}" class="atkInput"></label><br>
      <label>会心率(%): <input type="number" value="${char.crit_rate}" class="critInput"></label><br>
      <label>会心ダメ(%): <input type="number" value="${char.crit_dmg}" class="critDmgInput"></label><br>
      <button class="calcBtn">計算</button>
      <p class="result">予測ダメージ: ${char.predictedDmg}</p>
    `;
    container.appendChild(calcCard);

    const btn = calcCard.querySelector('.calcBtn');
    btn.onclick = () => {
      const atk = parseFloat(calcCard.querySelector('.atkInput').value) || 0;
      const crit = parseFloat(calcCard.querySelector('.critInput').value) || 0;
      const critDmg = parseFloat(calcCard.querySelector('.critDmgInput').value) || 0;
      // シンプルな計算式: ATK * (1 + CRIT_RATE * CRIT_DMG)
      const dmg = (atk * (1 + crit/100 * critDmg/100)).toFixed(1);
      calcCard.querySelector('.result').textContent = `予測ダメージ: ${dmg}`;
    };
  });
}

document.getElementById('showBuildBtn').onclick = showBuildCards;
document.getElementById('showDmgBtn').onclick = showDamageCalculator;
</script>
</body>
</html>
